<script type="text/html" data-template-name="ChatBot">

    <style>
        #chat-container {
            border: 1px solid #ccc;
            padding: 10px;
            width: 800px;
            height: 1000px;
            overflow-y: auto;
        }
        #chat-history {
            margin-bottom: 10px;
        }
        .user-message, .bot-message {
            padding: 10px;
            margin: 5px;
            border-radius: 10px;
            max-width: 80%;
        }
        .user-message {
            background-color: #abc5cf;
            text-align: right;
            align-self: flex-end;
            margin-left: auto;
        }
        .bot-message {
            background-color: #f0f0f0;
            text-align: left;
            align-self: flex-start;
            margin-right: auto;
        }
        #user-input {
            display: flex;
        }
        #user-text {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #send-button {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            margin-left: 5px;
        }
    </style>


    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div id="chat-container">
        <div id="chat-history"></div>
        <div id="user-input">
            <input type="text" id="user-text" placeholder="Type your message">
            <button id="send-button">Send</button>
        </div>
    </div>
</script>

<script type="text/javascript">



async function invokeAction(endpoint, queryString,node) {
    var url = "http://10.42.6.107:8000/invoke/" + endpoint;
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',  // Inform the server that the body is JSON
                
                Authorization: `Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsImlhdCI6MTcyMDcyNDAyOCwiZXhwIjoxNzIwNzI3NjI4fQ.q9xNFE0oSmqNvNyRn9vU539Yv3M6gKdBe_c8FqyewzU`
                
            },
            body: queryString
        });
        
        await response.json(); // Parse the JSON of the response
    } catch (error) {
        console.error("Fetch error: " + error); // Log any errors during the fetch
    }
}


/**
 * Convert an array of parameters to a JSON string.
 * @param {Array} parameterArray - The array of parameters to convert.
 * @returns {string} - The JSON string representation of the parameters.
 */
function toJsonString(parameterArray, msg) {
    var jsonString = "{";
    var length = parameterArray.length - 1;
    var count = 0;

    parameterArray.forEach(element => {
        jsonString += "\"" + element.value.name + "\":"; // Add parameter name

        if(element.value.value === "payload" && element.value.type === "string") jsonString += "\"" + msg.payload + "\"";
        else if(element.value.value === "payload")  jsonString += msg.payload;
        else element.value.type === "string" ? jsonString += "\"" + element.value.value + "\"" : jsonString += element.value.value;
        count !== length ? jsonString += "," : jsonString += "}";

        count++;
    });

    return jsonString; // Return the JSON string
}


    async function sendAction(variableName, value) {
        try {
            const response = await fetch(`http://localhost:3000/variable/${variableName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ value: value })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
        } catch (error) {
            console.error('Error:', error);
        }
    }


    async function sendMessagesToGPT(message,send){
        
        console.log(message);
        if(send){
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer sk-proj-FMah6efczx2EXI1fWrwIT3BlbkFJGhdW21Th0Z1lMJhnzMWj'
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        {"role": "system", "content": `You are a helpful assistant. Here Some users give commands to you and you have to respond to them. 
                                    You are the smart kitchen manager. User will ask you about opening a shelf or about the location of a specific item. 
                                    All you need to do for example, if user wants to open a shelf you have to respond kindly and give the opening shelf number 
                                    for me to open as a backend code, if user searches for a specific item you should give me searched item to search for it as backend code.
                                    for me to process the given data if user ask you to open a shelf I want you to always respond with the shelf number or user ask for specific item in the shelfs I want you to give me seacrhed item. You can kindly answer user. However you should give this info me at the end of your response`
                                },
                        {"role": "user", "content": message},
                    ]
                })
            });
            const completion = await response.json();
            return completion.choices[0].message.content;
        }
        else{
            return "123";
        }
    
    }

    RED.nodes.registerType('ChatBot', {
        category: 'ZEKI',
        color: '#a6bbcf',
        defaults: {
            name: { value: "" },
            isButtonClicked : { value: false },
            userMessage : { value: "" },
            gptMessage : { value: "" },
            conversation : { value: "" }
        },
        inputs: 1,
        outputs: 1,
        icon: 'icons/zekı_logo.png',
        label: function() {
            return this.name || 'ChatBot';
        },

        oneditprepare : async function(){
            var that = this;
            var shelf = 0;  
            console.log(that.shelfNumber);
            sendAction("shelfNumber", shelf);
            $("#send-button").click(function() {
                that.isButtonClicked = true;
                that.userMessage = $("#user-text").val();
                that.conversation += ("<div class='user-message'>" + that.userMessage + "</div>");
                $("#chat-history").append("<div class='user-message'>" + that.userMessage + "</div>");
                RED.events.emit("input", { id: that.id, payload: that.userMessage }); 
                $("#user-text").val('');
                sendMessagesToGPT(that.userMessage,true).then(function(response) {
                    that.gptMessage = response;
                    for (let i = 0; i < response.length; i++) {
                        if (response[i] === '1' || response[i] === '2' || response[i] === '3' || response[i] === '4' || response[i] === '5') {
                            shelf = parseInt(response[i]);
                            break;
                        }
                        else
                            shelf = 0;
                    }
                    invokeAction("OpenShelf", toJsonString([{ id: `shelf`, value: new Parameter(`shelf`, "int", shelf) }],that), that);
                    
                    sendAction("shelfNumber", shelf);
                    that.conversation += ("<div class='bot-message'>" + that.gptMessage + "</div>");
                    $("#chat-history").append("<div class='bot-message'>" + that.gptMessage + "</div>");
                    console.log("Detected"+shelf);
                }).catch(function(error) {
                    console.error('Error:', error);
                    $("#chat-history").append("<div class='bot-message'>Sorry, there was an error processing your request.</div>");
                });
            });

            if(that.conversation === undefined) {
                that.conversation = "<div class='bot-message'>Hello! How can I help you today?</div>";
            }

            $("#chat-history").empty().append(that.conversation);



        },

        oneditsave : async function(){
            var that = this;
            console.log("done");
            $("#chat-history").empty().append(that.conversation);
        },

        oneditclick : async function(){
            var that = this;
            console.log("cancelled");
            $("#chat-history").empty().append(that.conversation);
        },
    });
</script>
